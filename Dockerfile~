FROM gliderlabs/alpine
LABEL description="The Radicale CalDAV/CardDAV server as a Docker image." \
      maintainer="Alexander Mueller <XelaRellum@web.de>"

RUN set -xe && \
    apk update && apk upgrade && \
    apk add --no-cache --virtual=run-deps \
    s6 python3 python3-passlib python3-bcrypt apache-utils

# Add user www-data for php-fpm
# 82 is the standard uid/gid for "www-data" in Alpine
RUN adduser -u 82 -D -S -G www-data www-data

# Copy root file system
COPY root /

# Add s6 overlay
# Note: Tweak this line if you're running anything other than x86 AMD64 (64-bit)
RUN curl -L -s https://github.com/just-containers/s6-overlay/releases/download/v1.19.1.1/s6-overlay-amd64.tar.gz | tar xvzf - -C /

# expose Nginx ports
EXPOSE 8080
EXPOSE 4443

# expose default database credentials via ENV in order to ease overwriting
ENV DB_NAME ttrss
ENV DB_USER ttrss
ENV DB_PASS ttrss

# only run the setup once
RUN set -xe && /srv/setup-ttrss.sh

# clean up
RUN set -xe && apk del --progress --purge && rm -rf /var/cache/apk/*

ENTRYPOINT ["/init"]
